<!-- =========================================================================
  FILE: mail-dashboard.component.html
  Purpose:
  - Left sidebar: list + search + folders for MailMerge projects
  - Main area: spreadsheet connect, send/save, compose editor, preview + AI panels
  - Modals: create project, insert link, delete project confirmation

  Notes:
  - Most UI actions call methods in mail-dashboard.component.ts (e.g. toggleSidebar(), saveProject()).
  - Merge tokens + conditionals are rendered/validated in TS and sent to backend via ProjectService.
======================================================================== -->

<div class="mailmerge-shell" [class.mm-sidebar-collapsed]="sidebarCollapsed">
  <!-- =========================================================================
    LEFT SIDEBAR (navigation)
    - Sidebar collapse toggle
    - Create new project
    - Search
    - Project lists grouped by status (Drafts / Failed / Sent)
  ========================================================================= -->
  <aside class="mm-sidebar" role="navigation" aria-label="Mailmerges">
    <!-- Sidebar collapse/expand -->
    <button
      type="button"
      class="mm-sidebar-toggle"
      (click)="toggleSidebar()"
      [attr.aria-expanded]="!sidebarCollapsed"
      aria-label="Toggle mailmerges sidebar"
      title="Toggle sidebar"
    >
      <!-- Uses a simple chevron-style text icon -->
      <span class="mm-toggle-icon">{{ sidebarCollapsed ? '¬ª' : '¬´' }}</span>
    </button>

    <!-- Create project (opens create modal; see creatingProject flag in TS) -->
    <button type="button" class="mm-new-project" (click)="newProject()">
      <span class="mm-new-project-text">New MailMerge</span>
      <span class="mm-plus">+</span>
    </button>

    <div class="mm-sidebar-title">MailMerges</div>

    <!-- Sidebar search (bound to projectSearch in TS; used by filteredAllProjects getters) -->
    <div class="mm-project-search">
      <input
        type="text"
        class="mm-project-search-input"
        [(ngModel)]="projectSearch"
        name="projectSearch"
        placeholder="Search mailmerges‚Ä¶"
        autocomplete="off"
        spellcheck="false"
        [attr.aria-label]="'Search mailmerges'"
      />
    </div>

    <!-- Projects list (projects loaded via ProjectService.findMy() in TS loadProjects()) -->
    <ng-container *ngIf="projects?.length; else noProjectsTpl">
      <!-- ===============================================================
        UNGROUPED (status null/undefined)
        - Uses ungroupedProjects getter (filters by search + no status)
      =============================================================== -->
      <div class="mm-projects-list" *ngIf="ungroupedProjects.length">
        <button
          type="button"
          class="mm-project-item"
          *ngFor="let p of ungroupedProjects; trackBy: trackByProjectId"
          [class.active]="p.id === projectId"
          (click)="openProjectFromSidebar(p)"
          [attr.title]="p.name || 'Untitled Mailmerge'"
        >
          <div class="mm-project-main">
            <div class="mm-project-name">{{ p.name || 'Untitled Mailmerge' }}</div>
            <div class="mm-project-meta">
              <span class="mm-status">{{ p.status || '‚Äî' }}</span>
            </div>
          </div>

          <!-- NOTE: This is a <button> inside a <button> (invalid HTML).
               It may still work, but if you ever see weird click behaviour,
               swap outer container to a <div role="button"> or move delete outside. -->
          <button
            type="button"
            class="mm-project-delete"
            title="Delete"
            aria-label="Delete mailmerge"
            (click)="openDeleteProjectModal(p, $event)"
          >
            <fa-icon [icon]="faTrash"></fa-icon>
          </button>
        </button>
      </div>

      <!-- Divider only if ungrouped exists + any folder group exists -->
      <div
        class="mm-folder-divider"
        *ngIf="ungroupedProjects.length && (pendingProjects.length || sentProjects.length)"
      ></div>

      <!-- ===============================================================
        Folder: PENDING (Drafts)
        - toggleFolder('PENDING') flips folderOpen.PENDING in TS
      =============================================================== -->
      <button type="button" class="mm-folder" (click)="toggleFolder('PENDING')">
        <span class="mm-folder-caret">{{ folderOpen.PENDING ? '‚ñæ' : '‚ñ∏' }}</span>
        <span class="mm-folder-name">Drafts</span>
        <span class="mm-folder-count">{{ pendingProjects.length }}</span>
      </button>

      <div class="mm-projects-list" *ngIf="folderOpen.PENDING && pendingProjects.length">
        <button
          type="button"
          class="mm-project-item"
          *ngFor="let p of pendingProjects; trackBy: trackByProjectId"
          [class.active]="p.id === projectId"
          (click)="openProjectFromSidebar(p)"
          [attr.title]="p.name || 'Untitled Mailmerge'"
        >
          <div class="mm-project-main">
            <div class="mm-project-name">{{ p.name || 'Untitled Mailmerge' }}</div>
            <div class="mm-project-meta">
              <span class="mm-status">{{ p.status }}</span>
            </div>
          </div>

          <button
            type="button"
            class="mm-project-delete"
            title="Delete"
            aria-label="Delete mailmerge"
            (click)="openDeleteProjectModal(p, $event)"
          >
            <fa-icon [icon]="faTrash"></fa-icon>
          </button>
        </button>
      </div>

      <!-- ===============================================================
        Folder: SENT
      =============================================================== -->
      <button type="button" class="mm-folder" (click)="toggleFolder('SENT')">
        <span class="mm-folder-caret">{{ folderOpen.SENT ? '‚ñæ' : '‚ñ∏' }}</span>
        <span class="mm-folder-name">Sent</span>
        <span class="mm-folder-count">{{ sentProjects.length }}</span>
      </button>

      <div class="mm-projects-list" *ngIf="folderOpen.SENT && sentProjects.length">
        <button
          type="button"
          class="mm-project-item"
          *ngFor="let p of sentProjects; trackBy: trackByProjectId"
          [class.active]="p.id === projectId"
          (click)="openProjectFromSidebar(p)"
          [attr.title]="p.name || 'Untitled Mailmerge'"
        >
          <div class="mm-project-main">
            <div class="mm-project-name">{{ p.name || 'Untitled Mailmerge' }}</div>
            <div class="mm-project-meta">
              <span class="mm-status">{{ p.status }}</span>
            </div>
          </div>

          <button
            type="button"
            class="mm-project-delete"
            title="Delete"
            aria-label="Delete mailmerge"
            (click)="openDeleteProjectModal(p, $event)"
          >
            <fa-icon [icon]="faTrash"></fa-icon>
          </button>
        </button>
      </div>

      <!-- Search empty state (only when user has typed something) -->
      <div
        class="mm-empty"
        *ngIf="projectSearch && !ungroupedProjects.length && !pendingProjects.length && !sentProjects.length"
      >
        No matching mailmerges.
      </div>
    </ng-container>

    <!-- Sidebar empty state -->
    <ng-template #noProjectsTpl>
      <div class="mm-empty">No mailmerges found.</div>
    </ng-template>
  </aside>

  <!-- =========================================================================
    RIGHT MAIN (compose area)
    - Hidden inputs for file pickers
    - Spreadsheet connect + preview
    - Send/Save dropdown + progress bar (SSE)
    - Compose fields (To/Cc/Bcc/Subject/Body)
    - Bottom panels (AI + Preview)
    - Alternative right-side panels (howto/sheet/ai/preview/signature)
  ========================================================================= -->
  <main class="mm-main" role="main">
    <!-- If no project selected, show friendly blank state -->
    <ng-container *ngIf="hasSelectedProject; else noProjectSelectedTpl">
      <!-- Hidden file inputs triggered via TS (.click()) -->
      <input
        #mergeFileInput
        type="file"
        class="d-none"
        accept=".xlsx"
        (change)="onMergeFileChange($event)"
        [disabled]="oneDriveLoading"
      />

      <input #attachmentsInput type="file" class="d-none" multiple (change)="onAttachmentsChange($event)" />

      <!-- ===============================================================
        A) TOP TOOLBAR ‚Äî Spreadsheet connect + connected pill + inline preview
      =============================================================== -->
      <div class="mm-toolbar mm-toolbar--sheetonly">
        <div class="mm-toolbar-seg mm-toolbar-sheet">
          <!-- If no spreadsheet connected: show dropdown to choose Local / OneDrive -->
          <div class="mm-dropdown mm-sheet-dropdown" *ngIf="!hasConnectedSpreadsheet; else connectedSpreadsheetTpl">
            <button type="button" class="mm-btn mm-btn-excel" (click)="toggleSpreadsheetMenu()">
              Connect Spreadsheet
              <span class="mm-caret">‚ñæ</span>
            </button>

            <div class="mm-menu" *ngIf="spreadsheetMenuOpen">
              <!-- chooseSpreadsheet() closes menu + sets source + triggers picker -->
              <button
                type="button"
                class="mm-menu-item"
                (click)="chooseSpreadsheet('LOCAL')"
                [disabled]="oneDriveLoading"
              >
                Local spreadsheet
              </button>

              <button
                type="button"
                class="mm-menu-item"
                (click)="chooseSpreadsheet('ONEDRIVE')"
                [disabled]="oneDriveLoading"
              >
                OneDrive
              </button>
            </div>
          </div>

          <!-- Connected spreadsheet UI -->
          <ng-template #connectedSpreadsheetTpl>
            <div class="mm-sheet-connected">
              <!-- Expand/collapse the inline spreadsheet preview (spreadsheetPreviewOpen boolean in TS) -->
              <button
                type="button"
                class="mm-sheet-caret-btn"
                title="Preview spreadsheet"
                aria-label="Toggle spreadsheet preview"
                (click)="toggleSpreadsheetPreview($event)"
              >
                {{ spreadsheetPreviewOpen ? '‚ñæ' : '‚ñ∏' }}
              </button>

              <!-- Download link: downloadSpreadsheet() builds Blob from base64 and downloads with original name -->
              <a class="mm-sheet-name" href="#" (click)="downloadSpreadsheet($event)">
                {{ connectedSpreadsheetName }}
              </a>

              <!-- Shows if spreadsheet came from OneDrive (oneDriveSpreadsheetName set in TS) -->
              <span *ngIf="oneDriveSpreadsheetName" class="mm-badge">OneDrive</span>

              <!-- Remove spreadsheet clears parsed headers/rows + base64 (removeSpreadsheet() in TS) -->
              <button type="button" class="mm-icon-btn" title="Remove spreadsheet" (click)="removeSpreadsheet()">
                <fa-icon [icon]="faTrash"></fa-icon>
              </button>
            </div>

            <!-- Inline spreadsheet table preview (spreadsheetTable built in TS from XLSX parse) -->
            <div class="mm-sheet-preview" *ngIf="spreadsheetPreviewOpen && spreadsheetTable?.length">
              <div class="mm-sheet-scroll">
                <table class="table table-bordered table-sm mb-0 mm-sheet-table">
                  <thead>
                  <tr>
                    <!-- spreadsheetTable[0] is the header row -->
                    <th *ngFor="let h of spreadsheetTable[0]">{{ h }}</th>
                  </tr>
                  </thead>

                  <tbody>
                  <!-- spreadsheetTable.slice(1) are data rows; trackByRowIndex is a simple index trackBy in TS -->
                  <tr *ngFor="let row of spreadsheetTable.slice(1); trackBy: trackByRowIndex">
                    <td *ngFor="let cell of row">{{ cell }}</td>
                  </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </ng-template>
        </div>
      </div>

      <!-- OneDrive error area (set in TS when picker/download fails) -->
      <div class="mm-subrow">
        <div class="mm-subrow-left">
          <div *ngIf="oneDriveError" class="mm-error">{{ oneDriveError }}</div>
        </div>
      </div>

      <!-- Global toast messages (validation, success, errors) controlled by uiToast in TS -->
      <div
        *ngIf="uiToast"
        class="mm-toast"
        [class.mm-toast-ok]="uiToast.type === 'ok'"
        [class.mm-toast-warn]="uiToast.type === 'warn'"
        [class.mm-toast-error]="uiToast.type === 'error'"
        role="status"
        aria-live="polite"
      >
        {{ uiToast.text }}
      </div>

      <!-- ===============================================================
        OneDrive picker UI (only shown if oneDrivePickerVisible is true)
        - Populated via OneDriveService / OneDrivePickerV8Service in TS
      =============================================================== -->
      <div *ngIf="oneDrivePickerVisible" class="mm-onedrive-picker">
        <div class="mm-onedrive-header">
          <strong>Select a spreadsheet from your OneDrive</strong>
          <button type="button" class="mm-link" (click)="closeOneDrivePicker()">‚úï Close</button>
        </div>

        <div *ngIf="oneDriveLoading" class="mm-muted">Loading OneDrive files‚Ä¶</div>

        <ul class="list-group" *ngIf="!oneDriveLoading && oneDriveFiles?.length">
          <li *ngFor="let f of oneDriveFiles" class="list-group-item d-flex justify-content-between align-items-center">
            <div>
              <fa-icon [icon]="faFileExcel" class="text-success me-2"></fa-icon>
              <span>{{ f.name }}</span>
            </div>

            <!-- selectOneDriveFile() downloads the bytes and loads via loadSpreadsheetFile() -->
            <button type="button" class="mm-btn" (click)="selectOneDriveFile(f)">Use this</button>
          </li>
        </ul>

        <div *ngIf="!oneDriveLoading && !oneDriveFiles?.length && !oneDriveError" class="mm-muted">
          No spreadsheets found in your OneDrive root.
        </div>
      </div>

      <!-- ===============================================================
        B) MERGE FIELDS ROW
        - Shows header ‚Äúchips‚Äù when spreadsheetHeaders exist
        - Dragging inserts {{Header}} into To/Cc/Bcc/Subject/Body via onDrop()
      =============================================================== -->
      <div *ngIf="spreadsheetHeaders?.length" class="mm-merge-fields-row">
        <div class="mm-merge-fields-scroll">
          <span
            *ngFor="let header of spreadsheetHeaders"
            class="mm-merge-field"
            draggable="true"
            (dragstart)="onDragStart($event, header)"
            [style.background]="getColorForField(header)"
          >
            {{ header }}
          </span>
        </div>
      </div>

      <div class="mm-collapsible mm-cond-builder">
        <button
          type="button"
          class="mm-collapsible-header mm-cond-header"
          (click)="toggleConditionals()"
          [attr.aria-expanded]="conditionalsOpen"
        >
    <span class="mm-bottom-panel-title">
      <span class="mm-sheet-caret-btn" aria-hidden="true">{{ conditionalsOpen ? '‚ñæ' : '‚ñ∏' }}</span>
      <span>Conditionals</span>
    </span>
        </button>

        <div class="mm-collapsible-body mm-cond-body" *ngIf="conditionalsOpen">
          <div class="mm-cond-grid">
            <!-- LEFT: controls -->
            <div class="mm-cond-controls">
              <!-- Row: conditional type -->
              <div class="mm-cond-row">
                <div class="mm-cond-label">Type</div>

                <select
                  class="form-select mm-cond-select"
                  [(ngModel)]="selectedConditionalType"
                  name="selectedConditionalType"
                >
                  <option [ngValue]="null">Select conditional‚Ä¶</option>
                  <option [ngValue]="'if'">[[if]] block</option>
                  <option [ngValue]="'nestedIf'">Nested [[if]] block</option>
                  <option [ngValue]="'thunderbird'">Thunderbird one-liner</option>
                </select>
              </div>

              <!-- Row: merge field -->
              <div class="mm-cond-row">
                <div class="mm-cond-label">Field</div>

                <select
                  class="form-select mm-cond-select"
                  [(ngModel)]="selectedConditionalField"
                  name="selectedConditionalField"
                  [disabled]="!spreadsheetHeaders?.length"
                >
                  <option [ngValue]="null">
                    {{ spreadsheetHeaders?.length ? 'Select merge field‚Ä¶' : 'Connect a spreadsheet to enable fields‚Ä¶' }}
                  </option>

                  <option *ngFor="let h of spreadsheetHeaders" [ngValue]="h">{{ h }}</option>
                </select>
              </div>

              <div class="mm-muted" *ngIf="!canBuildConditional">
                Select a conditional type and a field (and connect a spreadsheet if needed) to enable drag & drop.
              </div>
            </div>

            <!-- RIGHT: draggable snippet -->
            <div class="mm-cond-snippet-wrap">
              <div class="mm-cond-snippet-title">Drag & drop</div>

              <div
                class="mm-draggable mm-cond-snippet"
                [class.mm-disabled]="!canBuildConditional"
                [attr.draggable]="canBuildConditional ? 'true' : 'false'"
                (dragstart)="onConditionalBuilderDragStart($event)"
                [innerHTML]="conditionalSnippetPreviewHtml"
                title="Drag into To/Subject/Body etc."
              ></div>
            </div>
          </div>
        </div>
      </div>

      <!-- ===============================================================
        C) SEND/SAVE + PROGRESS ROW
        - Dropdown calls saveProject(), testProject(), queueSendProject()
        - Progress bar updates via SSE stream in TS listenToMailProgress()
      =============================================================== -->
      <div class="mm-action-row">
        <div class="mm-action-left">
          <div class="mm-dropdown">
            <button
              type="button"
              class="mm-btn mm-btn-primary"
              (click)="toggleSendMenu()"
              [disabled]="!projectId"
            >
              Send / Save
              <span class="mm-caret">‚ñæ</span>
            </button>

            <div class="mm-menu" *ngIf="sendMenuOpen">
              <button
                type="button"
                class="mm-menu-item"
                (click)="saveProject(); sendMenuOpen=false"
                [disabled]="saving"
              >
                Save
              </button>

              <button
                type="button"
                class="mm-menu-item"
                (click)="testProject(); sendMenuOpen=false"
                [disabled]="testSending() || mergeSending() || saving"
              >
                Sample
              </button>

              <button
                type="button"
                class="mm-menu-item"
                (click)="queueSendProject(); sendMenuOpen=false"
                [disabled]="mergeSending() || sendQueued()"
              >
                Send
              </button>
            </div>
          </div>

          <!-- Inline status feedback driven by TS flags -->
          <div class="mm-status-inline">
            <span *ngIf="sendQueued()" class="mm-warn">
              ‚è≥ Sending in {{ sendQueuedSeconds() }}s
              <button type="button" class="mm-link" (click)="undoQueuedSend()">Undo</button>
            </span>

            <span *ngIf="saveSuccess" class="mm-ok">‚úÖ Saved</span>
            <span *ngIf="testSuccess" class="mm-ok">‚úÖ Test sent</span>
            <span *ngIf="sendSuccess" class="mm-ok">‚úÖ Sent</span>

            <span *ngIf="testErr()" class="mm-bad">‚ùå Test failed</span>
            <span *ngIf="mergeErr()" class="mm-bad">‚ùå Mail merge failed</span>
          </div>
        </div>

        <!-- Progress bar is visible during sending + briefly after completion -->
        <div class="mm-action-right" *ngIf="sendingInProgress || sendingFinished">
          <div class="progress mm-progress">
            <div
              class="progress-bar"
              role="progressbar"
              [class.progress-bar-striped]="sendingInProgress && sendingTotal === 0"
              [class.progress-bar-animated]="sendingInProgress && sendingTotal === 0"
              [style.width.%]="sendingTotal > 0 ? (sendingProgress / sendingTotal) * 100 : 100"
            >
              <ng-container *ngIf="sendingInProgress; else finishedTpl">
                <ng-container *ngIf="sendingTotal > 0; else startingTpl">
                  {{ sendingProgress }} / {{ sendingTotal }}
                </ng-container>
                <ng-template #startingTpl>Sending‚Ä¶</ng-template>
              </ng-container>

              <ng-template #finishedTpl> ‚úÖ {{ sendingTotal }} / {{ sendingTotal }} </ng-template>
            </div>
          </div>
        </div>
      </div>

      <!-- ===============================================================
        D) COMPOSE FORM (only when activePanel === 'compose')
        - contenteditable editors write back into TS via onEditorInput(field)
        - drag/drop inserts tokens via onDrop()
        - formatting toolbar calls formatFromToolbar()
        - paste handler supports inline images (onEditorPaste)
      =============================================================== -->
      <form *ngIf="activePanel === 'compose'" #mergeForm="ngForm" novalidate class="mm-form">
        <div class="mm-compose">
          <!-- TO -->
          <div class="mm-compose-row">
            <div class="mm-compose-label">To</div>

            <div
              id="toField"
              class="mm-line-editor merge-editor"
              contenteditable="true"
              (drop)="onDrop($event, 'to')"
              (dragover)="allowDrop($event)"
              (input)="onEditorInput('to')"
            ></div>

            <!-- Toggle showing CC+BCC -->
            <button type="button" class="mm-link-btn" (click)="toggleCcBcc()">
              {{ showCcBcc ? 'Hide Cc/Bcc' : 'Cc/Bcc' }}
            </button>
          </div>

          <!-- CC + BCC (collapsible together) -->
          <ng-container *ngIf="showCcBcc">
            <!-- CC -->
            <div class="mm-compose-row">
              <div class="mm-compose-label">Cc</div>

              <div
                id="ccField"
                class="mm-line-editor merge-editor"
                contenteditable="true"
                (drop)="onDrop($event, 'cc')"
                (dragover)="allowDrop($event)"
                (input)="onEditorInput('cc')"
              ></div>
            </div>

            <!-- BCC -->
            <div class="mm-compose-row">
              <div class="mm-compose-label">Bcc</div>

              <div
                id="bccField"
                class="mm-line-editor merge-editor"
                contenteditable="true"
                (drop)="onDrop($event, 'bcc')"
                (dragover)="allowDrop($event)"
                (input)="onEditorInput('bcc')"
              ></div>
            </div>
          </ng-container>

          <!-- SUBJECT -->
          <div class="mm-compose-row">
            <div class="mm-compose-label"></div>

            <div
              id="mergeSubject"
              class="mm-line-editor merge-editor"
              contenteditable="true"
              data-placeholder="Add a subject"
              (drop)="onDrop($event, 'subject')"
              (dragover)="allowDrop($event)"
              (input)="onEditorInput('subject')"
            ></div>
          </div>

          <!-- Formatting bar (between subject and body) -->
          <div class="mm-format-bar" role="toolbar" aria-label="Formatting">
            <!-- Uses (mousedown) so toolbar click doesn‚Äôt steal the selection before formatting is applied -->
            <button type="button" class="mm-icon-btn" title="Bold" (mousedown)="formatFromToolbar($event, 'bold')">
              <b>B</b>
            </button>
            <button type="button" class="mm-icon-btn" title="Italic" (mousedown)="formatFromToolbar($event, 'italic')">
              <i>I</i>
            </button>
            <button
              type="button"
              class="mm-icon-btn"
              title="Underline"
              (mousedown)="formatFromToolbar($event, 'underline')"
            >
              <u>U</u>
            </button>

            <span class="mm-format-divider" aria-hidden="true"></span>

            <!-- HTTPS link modal: insertHttpsLink() opens modal and stores selection range -->
            <button type="button" class="mm-icon-btn" title="Insert HTTPS link" (mousedown)="insertHttpsLink($event)">
              <fa-icon [icon]="faLink"></fa-icon>
            </button>

            <!-- Attachments picker: triggers hidden #attachmentsInput click in TS -->
            <button type="button" class="mm-icon-btn" title="Attachments" (click)="openAttachmentsPicker()">
              <fa-icon [icon]="faPaperclip"></fa-icon>
            </button>
          </div>

          <!-- BODY -->
          <div class="mm-compose-body">
            <div
              id="mergeBody"
              class="mm-body-editor merge-editor"
              contenteditable="true"
              data-placeholder="Type here to write your mailmerge"
              (paste)="onEditorPaste($event, 'body')"
              (drop)="onDrop($event, 'body')"
              (dragover)="allowDrop($event)"
              (input)="onEditorInput('body')"
              (mouseup)="saveBodySelection()"
              (keyup)="saveBodySelection()"
            ></div>
          </div>
        </div>

        <!-- Attachments list (rendered from attachments[] in TS) -->
        <div class="mm-attachments" *ngIf="attachments.length">
          <div class="mm-attachments-title">Attachments</div>
          <ul class="list-unstyled mb-0">
            <li *ngFor="let a of attachments; let i = index" class="mm-attachment-item">
              <!-- downloadAttachment() builds Blob from base64 -->
              <a href="#" (click)="downloadAttachment(a, $event)">
                {{ a.name }} ({{ (a.size / 1024).toFixed(1) }} KB)
              </a>
              <!-- removeAttachment() tracks deleted IDs for DB cleanup in saveProject() -->
              <button type="button" class="mm-link-danger" (click)="removeAttachment(i)">Remove</button>
            </li>
          </ul>
        </div>
      </form>

      <!-- ===============================================================
        Bottom panels (only shown when composing):
        - AI (rewrites body via AiRewriteService in TS)
        - Preview (shows per-row rendered output; previewMerge() in TS)
      =============================================================== -->
      <div class="mm-bottom-split" *ngIf="activePanel === 'compose'">
        <div class="mm-bottom-split-grid">
          <!-- AI panel -->
          <div class="mm-collapsible">
            <button
              type="button"
              class="mm-collapsible-header mm-bottom-panel-header"
              (click)="toggleBottomPanel('ai')"
              [attr.aria-expanded]="bottomAiOpen"
            >
              <span class="mm-bottom-panel-title">
                <span class="mm-sheet-caret-btn" aria-hidden="true">{{ bottomAiOpen ? '‚ñæ' : '‚ñ∏' }}</span>
                <span>AI Improvement</span>
              </span>
            </button>

            <div class="mm-collapsible-body" *ngIf="bottomAiOpen">
              <h4 class="mb-3">Select Your Tone</h4>

              <div class="d-flex gap-3 mb-3 flex-wrap mm-ai-actions">
                <button
                  class="mm-btn mm-btn-primary"
                  (click)="rewriteEmailBody('professional')"
                  [disabled]="isRewriting || !mergeBodyTemplate"
                >
                  ‚ú® Professional
                </button>

                <button
                  class="mm-btn mm-btn-primary"
                  (click)="rewriteEmailBody('friendly')"
                  [disabled]="isRewriting || !mergeBodyTemplate"
                >
                  üôÇ Friendly
                </button>

                <button
                  class="mm-btn mm-btn-primary"
                  (click)="rewriteEmailBody('custom')"
                  [disabled]="isRewriting || !mergeBodyTemplate || !customTone"
                >
                  üéØ Custom
                </button>
              </div>

              <input
                type="text"
                class="form-control mb-3"
                [(ngModel)]="customTone"
                name="customTone"
                placeholder="e.g. more concise, persuasive, motivational..."
                style="max-width: 420px;"
              />

              <!-- Preview is sanitized HTML created in TS (aiRewrittenPreview) -->
              <div *ngIf="aiRewrittenText && !isRewriting" class="mm-ai-preview">
                <h5>Suggested Rewrite</h5>
                <div class="mm-ai-preview-content" [innerHTML]="aiRewrittenPreview"></div>
                <button class="mm-btn mm-btn-primary mt-2" (click)="applyRewrittenEmail()">‚úÖ Use This Email</button>
              </div>

              <div *ngIf="isRewriting" class="mm-muted">Rewriting‚Ä¶</div>
            </div>
          </div>

          <!-- Preview panel -->
          <div class="mm-collapsible">
            <button
              type="button"
              class="mm-collapsible-header mm-bottom-panel-header"
              (click)="toggleBottomPanel('preview')"
              [attr.aria-expanded]="bottomPreviewOpen"
            >
              <span class="mm-bottom-panel-title">
                <span class="mm-sheet-caret-btn" aria-hidden="true">{{ bottomPreviewOpen ? '‚ñæ' : '‚ñ∏' }}</span>
                <span>Preview</span>
                <span class="mm-folder-count" *ngIf="previewEmails?.length">{{ previewEmails.length }}</span>
              </span>
            </button>

            <div class="mm-collapsible-body" *ngIf="bottomPreviewOpen">
              <div *ngIf="previewEmails.length > 0; else noPreviewTpl" class="mm-preview-list">
                <div *ngFor="let email of previewEmails" class="mm-preview-item">
                  <div class="mm-email-header">
                    <div><strong>To:</strong> {{ email.to }}</div>
                    <div *ngIf="email.cc"><strong>CC:</strong> {{ email.cc }}</div>
                    <div *ngIf="email.bcc"><strong>BCC:</strong> {{ email.bcc }}</div>
                    <div><strong>Subject:</strong> {{ email.subject }}</div>
                    <span class="mm-email-date">Now</span>
                  </div>

                  <!-- email.body is SafeHtml prepared in TS using DomSanitizer -->
                  <div class="mm-email-body mt-2">
                    <div [innerHTML]="email.body"></div>
                  </div>

                  <div *ngIf="email.attachments?.length" class="mm-preview-attachments mt-2">
                    <strong>Attachments:</strong>
                    <ul class="list-unstyled mt-1 mb-0">
                      <li *ngFor="let file of email.attachments" class="mm-attachment-chip">
                        üìé {{ file.name }} ({{ (file.size / 1024).toFixed(1) }} KB)
                      </li>
                    </ul>
                  </div>
                </div>
              </div>

              <ng-template #noPreviewTpl>
                <div class="mm-muted">No preview available yet. Start writing your mailmerge!</div>
              </ng-template>
            </div>
          </div>
        </div>
      </div>

      <!-- ===============================================================
        Right-side panels (non-compose modes)
        - Controlled by activePanel (RightPanel union in TS)
      =============================================================== -->
      <section class="mm-panels" *ngIf="activePanel !== 'compose'">
        <!-- HOW TO -->
        <div *ngIf="activePanel === 'howto'" class="mm-panel">
          <h4>How to use MailMerge</h4>
          <p class="mm-muted">
            1Ô∏è‚É£ Upload an Excel file with a header row ‚Äî must include a column named <code>email</code>.<br /><br />
            2Ô∏è‚É£ Use placeholders like <code>{{'{{name}}'}}</code> or <code>{{'{{course}}'}}</code>.<br /><br />
            3Ô∏è‚É£ Click <strong>Preview</strong> to see personalized emails.<br /><br />
            4Ô∏è‚É£ Click <strong>Send</strong> to send them all.
          </p>
        </div>

        <!-- SHEET (separate panel view; you also have an inline sheet preview above) -->
        <div *ngIf="activePanel === 'sheet' && spreadsheetTable && spreadsheetTable.length" class="mm-panel">
          <h4>Spreadsheet Preview</h4>
          <table class="table table-bordered table-sm mt-2">
            <thead>
            <tr>
              <th *ngFor="let h of spreadsheetTable[0]">{{ h }}</th>
            </tr>
            </thead>
            <tbody>
            <tr *ngFor="let row of spreadsheetTable.slice(1)">
              <td *ngFor="let cell of row">{{ cell }}</td>
            </tr>
            </tbody>
          </table>
        </div>

        <!-- AI (separate panel view; you also have a bottom AI panel during compose) -->
        <div *ngIf="activePanel === 'ai'" class="mm-panel">
          <h4 class="mb-3">Select Your Tone</h4>

          <div class="d-flex gap-3 mb-3 flex-wrap mm-ai-actions">
            <button class="mm-btn mm-btn-primary" (click)="rewriteEmailBody('professional')" [disabled]="isRewriting || !mergeBodyTemplate">
              ‚ú® Professional
            </button>

            <button class="mm-btn mm-btn-primary" (click)="rewriteEmailBody('friendly')" [disabled]="isRewriting || !mergeBodyTemplate">
              üôÇ Friendly
            </button>

            <button class="mm-btn mm-btn-primary" (click)="rewriteEmailBody('custom')" [disabled]="isRewriting || !mergeBodyTemplate || !customTone">
              üéØ Custom
            </button>
          </div>

          <input
            type="text"
            class="form-control mb-3"
            [(ngModel)]="customTone"
            name="customTone"
            placeholder="e.g. more concise, persuasive, motivational..."
            style="max-width: 420px;"
          />

          <div *ngIf="aiRewrittenText && !isRewriting" class="mm-ai-preview">
            <h5>Suggested Rewrite</h5>
            <div class="mm-ai-preview-content" [innerHTML]="aiRewrittenPreview"></div>
            <button class="mm-btn mm-btn-primary mt-2" (click)="applyRewrittenEmail()">‚úÖ Use This Email</button>
          </div>
        </div>

        <!-- PREVIEW (separate panel view; you also have a bottom Preview panel during compose) -->
        <div *ngIf="activePanel === 'preview' && previewEmails.length > 0" class="mm-panel">
          <h4 class="mb-3">Email Preview ({{ previewEmails.length }})</h4>
          <div class="mm-preview-list">
            <div *ngFor="let email of previewEmails" class="mm-preview-item">
              <div class="mm-email-header">
                <div><strong>To:</strong> {{ email.to }}</div>
                <div *ngIf="email.cc"><strong>CC:</strong> {{ email.cc }}</div>
                <div *ngIf="email.bcc"><strong>BCC:</strong> {{ email.bcc }}</div>
                <div><strong>Subject:</strong> {{ email.subject }}</div>
                <span class="mm-email-date">Now</span>
              </div>

              <div class="mm-email-body mt-2">
                <div [innerHTML]="email.body"></div>
              </div>

              <div *ngIf="email.attachments?.length" class="mm-preview-attachments mt-2">
                <strong>Attachments:</strong>
                <ul class="list-unstyled mt-1 mb-0">
                  <li *ngFor="let file of email.attachments" class="mm-attachment-chip">
                    üìé {{ file.name }} ({{ (file.size / 1024).toFixed(1) }} KB)
                  </li>
                </ul>
              </div>
            </div>
          </div>
        </div>

        <!-- SIGNATURE -->
        <div *ngIf="activePanel === 'signature'" class="mm-panel">
          <h4 class="mb-2">Signature</h4>
          <div class="mm-muted mb-2">Paste or type your signature below</div>

          <!-- Signature editor:
               - contenteditable is saved via onSignatureInput() -> signatureDraftHtml (TS)
               - saveSignature() persists via SignatureService.update() (TS) -->
          <div
            id="signatureEditor"
            class="mm-body-editor"
            contenteditable="true"
            data-placeholder="e.g. Regards, John..."
            (paste)="onEditorPaste($event, 'signature')"
            (input)="onSignatureInput()"
          ></div>

          <div class="d-flex gap-2 mt-2 flex-wrap">
            <button type="button" class="mm-btn mm-btn-primary" (click)="saveSignature()">Save</button>
            <button type="button" class="mm-link" (click)="setPanel('compose')">Cancel</button>
          </div>
        </div>

        <!-- Empty states for right-side panels -->
        <div *ngIf="activePanel === 'preview' && previewEmails.length === 0" class="mm-panel">
          <h4 class="mb-2">Email Preview</h4>
          <div class="mm-muted">No preview available yet. Connect a spreadsheet first.</div>
        </div>

        <div *ngIf="activePanel === 'sheet' && (!spreadsheetTable || !spreadsheetTable.length)" class="mm-panel">
          <h4 class="mb-2">Spreadsheet Preview</h4>
          <div class="mm-muted">No spreadsheet connected yet.</div>
        </div>
      </section>
    </ng-container>

    <!-- =========================================================================
      No project selected state
      - Appears when /mail has no :id route param (see route.params subscription in TS)
    ========================================================================= -->
    <ng-template #noProjectSelectedTpl>
      <div class="mm-panel" style="height: 100%; display: flex; align-items: center; justify-content: center;">
        <div style="text-align: center; max-width: 520px;">
          <h4 style="margin-bottom: 8px;">Select or create a mailmerge</h4>
          <div class="mm-muted">Use the Mailmerge sidebar on the left to get started.</div>
        </div>
      </div>
    </ng-template>
  </main>
</div>

<!-- =========================================================================
  Hyperlink modal (HTTPS-only)
  - Opened via insertHttpsLink() in TS, which saves the selection range
  - confirmInsertLink() inserts <a href="https://..."> into the body editor
======================================================================== -->
<div *ngIf="linkModalOpen" class="mm-modal-backdrop" (click)="closeLinkModal()">
  <div
    class="mm-modal"
    role="dialog"
    aria-modal="true"
    aria-labelledby="mmLinkTitle"
    (click)="$event.stopPropagation()"
  >
    <div class="mm-modal-header">
      <div id="mmLinkTitle" class="mm-modal-title">Insert link</div>
      <button type="button" class="mm-icon-btn" title="Close" (click)="closeLinkModal()">‚úï</button>
    </div>

    <div class="mm-modal-body">
      <label class="mm-modal-label">Text</label>
      <input class="form-control" type="text" [(ngModel)]="linkTextDraft" name="linkTextDraft" />

      <label class="mm-modal-label mt-2">URL (https only)</label>
      <input
        id="mmLinkUrl"
        class="form-control"
        type="url"
        [(ngModel)]="linkUrlDraft"
        name="linkUrlDraft"
        placeholder="https://example.com"
        (keydown.enter)="confirmInsertLink()"
      />

      <div *ngIf="linkError" class="mm-error mt-2">{{ linkError }}</div>
    </div>

    <div class="mm-modal-footer">
      <button type="button" class="mm-btn" (click)="closeLinkModal()">Cancel</button>
      <button type="button" class="mm-btn mm-btn-primary" (click)="confirmInsertLink()">Insert</button>
    </div>
  </div>
</div>

<!-- =========================================================================
  Delete project confirmation modal
  - Opened via openDeleteProjectModal(p, $event) in TS
  - confirmDeleteProject() calls ProjectService.delete(id) in TS
======================================================================== -->
<div class="mm-modal-backdrop" *ngIf="deleteConfirmOpen" (click)="cancelDeleteProject()">
  <div
    class="mm-modal"
    role="dialog"
    aria-modal="true"
    aria-labelledby="mmDeleteTitle"
    (click)="$event.stopPropagation()"
  >
    <div class="mm-modal-header">
      <div id="mmDeleteTitle" class="mm-modal-title">Delete mailmerge?</div>
      <button type="button" class="mm-icon-btn" title="Close" (click)="cancelDeleteProject()">‚úï</button>
    </div>

    <div class="mm-modal-body">
      <p class="mm-muted">
        This will permanently delete <strong>{{ projectName || 'this project' }}</strong>.
        <br />
        This action cannot be undone.
      </p>
    </div>

    <div class="mm-modal-footer">
      <button type="button" class="mm-btn" (click)="cancelDeleteProject()">Cancel</button>
      <button type="button" class="mm-btn mm-btn-danger" (click)="confirmDeleteProject()">Delete</button>
    </div>
  </div>
</div>
